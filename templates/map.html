<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFOcJTlTqElkeDRFcXylFe23dOMPn9Ak4&sensor=false">
    </script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/1.7/jquery.min.js'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.2.1/underscore-min.js'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.5.3/backbone-min.js'></script>
    <script type="text/javascript">
      function initialize() {
        var mapOptions = {
          zoom: 16,
          disableDoubleClickZoom: true,
          center: new google.maps.LatLng(38.03561521701325, -78.50336015224457)
        };

        var map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);

        //Creating a new marker on double-click
        google.maps.event.addListener(map, 'dblclick', function(m) {
          placeMarker(m.latLng, map, false, true)
        });
        
        //Populate with data from the server
        $.ajax({
          type: 'GET',
          url: '/get/',
          async: false,
          success: function(result){
            var events = $.parseJSON(result);
            $.each(events, function(i, event_obj) {
              var data = event_obj
              var longitude = event_obj['longitude'];
              var latitude = event_obj['latitude'];
              var location = new google.maps.LatLng(Number(latitude), Number(longitude));
              placeMarker(location, map, data);
            })
          }
        });
      }

      function placeMarker(location, map, data, info_window) {
        var info_window = info_window || false;
        var data = data || false
        var marker = new google.maps.Marker({
            position: location,
            map: map,
            name: (data['name'] || false)
        });
        if ( info_window ) {
          var html = "<div id='infoWindow'><label for='eventName'>Name:</label> <input type='text' id='eventName' /><br />" +
                     "<input type='hidden' id='eventLat' value='" + location.lat() + "' /><input type='hidden' id='eventLon' value='" + location.lng() + "' />" +
                     "<input type='button' id='eventSubmit' value='Save' onclick='submitEvent()' /></div>";
          var event_form_info_window = new google.maps.InfoWindow(
            {
              content: html
            });
          event_form_info_window.open(map, marker);
        } else {
          google.maps.event.addListener(marker, 'click', function(m) {
            var info_pane = "<div id='infoWindow'><span>" + data['name'] + "</span></div>";
            var event_form_info_window = new google.maps.InfoWindow(
              {
                content: info_pane
              });
            event_form_info_window.open(map, marker);
          });
        }
      }

      function submitEvent() {
        var name = $("#eventName").val();
        var latitude = $("#eventLat").val();
        var longitude = $("#eventLon").val();
        var event_obj = {name: name, latitude: latitude, longitude: longitude};

        var result = $.ajax({
          type: 'POST',
          data: event_obj,
          dataType: 'text',
          url: '/add/',
          success: function() {
            $("#infoWindow").html("<p>Success!</p>");
          }
          
        });
        result.error(function() { alert("Something went wrong"); });
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div style="width: 200px; height: 100%; float: right;"></div>
    <div id="map-canvas"></div>
  </body>
</html>
